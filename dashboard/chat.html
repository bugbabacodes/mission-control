<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mission Control | Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./js/data-manager.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-primary': '#0f0f1a',
                        'bg-secondary': '#1a1a2e',
                        'accent-cyan': '#00d4ff',
                        'accent-purple': '#7b2cbf',
                        'accent-pink': '#ff006e',
                        'accent-green': '#00f5d4',
                        'accent-yellow': '#ffb703',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #0f0f1a; color: white; }
        .glass { background: rgba(26, 26, 46, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
        .gradient-1 { background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%); }
        .text-gradient { background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes bgPulse {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
        }
        .bg-animated::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle at 20% 30%, rgba(0, 212, 255, 0.08) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(123, 44, 191, 0.08) 0%, transparent 40%);
            animation: bgPulse 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        .message-user { background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%); border-radius: 18px 18px 4px 18px; }
        .message-agent { background: rgba(255,255,255,0.08); border-radius: 18px 18px 18px 4px; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .mention { background: rgba(0, 212, 255, 0.2); color: #00d4ff; padding: 2px 6px; border-radius: 6px; font-weight: 500; }
    </style>
</head>
<body class="bg-animated min-h-screen">
    <!-- Desktop Sidebar -->
    <aside class="hidden lg:flex fixed left-0 top-0 h-screen w-72 glass flex-col p-6 z-20">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-10 h-10 gradient-1 rounded-xl flex items-center justify-center text-xl shadow-lg shadow-cyan-500/30">üéØ</div>
            <span class="text-xl font-bold text-gradient">Mission Control</span>
        </div>
        <nav class="flex-1 space-y-1">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-3 px-3">Main</p>
            <a href="./index.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="./agents.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">ü§ñ</span>
                <span>Agents</span>
            </a>
            <a href="./tasks.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">üìã</span>
                <span>Tasks</span>
            </a>
            <a href="./content.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">üìù</span>
                <span>Content</span>
            </a>
            <a href="./instructions.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">üìñ</span>
                <span>Instructions</span>
            </a>
            <p class="text-xs text-gray-500 uppercase tracking-wider mt-6 mb-3 px-3">Operations</p>
            <a href="./leads.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-white transition-all">
                <span class="text-xl">üë•</span>
                <span>Leads</span>
            </a>
            <a href="./chat.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">
                <span class="text-xl">üí¨</span>
                <span class="font-medium">Chat</span>
            </a>
        </nav>
    </aside>

    <!-- Chat Container -->
    <div class="lg:ml-72 h-screen flex flex-col relative z-10">
        <!-- Chat Header -->
        <header class="glass border-b border-white/10 px-4 py-3 flex items-center gap-3 shrink-0">
            <a href="./index.html" class="lg:hidden w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white transition-all -ml-2">
                <span class="text-xl">&larr;</span>
            </a>
            <div class="flex -space-x-2">
                <div class="w-10 h-10 bg-cyan-500/20 rounded-full flex items-center justify-center text-lg border-2 border-[#0f0f1a]">‚ò¢Ô∏è</div>
                <div class="w-10 h-10 bg-pink-500/20 rounded-full flex items-center justify-center text-lg border-2 border-[#0f0f1a]">ü™∂</div>
                <div class="w-10 h-10 bg-yellow-500/20 rounded-full flex items-center justify-center text-lg border-2 border-[#0f0f1a]">üß†</div>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="font-bold text-sm md:text-base truncate">Agent Team</h1>
                <p class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span>
                    5 agents online
                </p>
            </div>
        </header>

        <!-- Messages Area -->
        <main id="messagesContainer" class="flex-1 overflow-y-auto hide-scrollbar p-4 space-y-4 pb-32">
            <div class="flex items-center justify-center my-4">
                <span class="text-xs text-gray-500 bg-[#0f0f1a]/80 px-3 py-1 rounded-full">Today</span>
            </div>
            
            <div class="flex gap-3">
                <div class="w-8 h-8 gradient-1 rounded-full flex items-center justify-center text-sm shrink-0 border border-white/10">üéØ</div>
                <div class="flex-1 max-w-[80%]">
                    <div class="message-agent p-3.5 text-sm text-white/90">
                        <p class="font-semibold text-cyan-400 mb-1">Mission Control</p>
                        <p>Welcome to Agent Chat! Use @mentions to message specific agents.</p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="mention cursor-pointer" onclick="addMention('@marie_curie')">@marie_curie</span>
                            <span class="mention cursor-pointer" onclick="addMention('@shakespeare')">@shakespeare</span>
                            <span class="mention cursor-pointer" onclick="addMention('@jack')">@jack</span>
                            <span class="mention cursor-pointer" onclick="addMention('@johnny')">@johnny</span>
                            <span class="mention cursor-pointer" onclick="addMention('@nightingale')">@nightingale</span>
                        </div>
                    </div>
                    <span class="text-[10px] text-gray-500 mt-1 ml-1">9:00 AM</span>
                </div>
            </div>
        </main>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-4 py-2">
            <div class="flex gap-3">
                <div id="typingAvatar" class="w-8 h-10 bg-cyan-500/20 rounded-full flex items-center justify-center text-sm shrink-0 border border-white/10">‚ò¢Ô∏è</div>
                <div class="message-agent px-4 py-3 flex items-center gap-1">
                    <span class="w-2 h-2 bg-white/50 rounded-full typing-dot"></span>
                    <span class="w-2 h-2 bg-white/50 rounded-full typing-dot"></span>
                    <span class="w-2 h-2 bg-white/50 rounded-full typing-dot"></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <footer class="glass border-t border-white/10 p-3 pb-safe shrink-0 fixed bottom-16 lg:bottom-0 left-0 right-0 lg:left-72 z-20">
            <div class="flex items-end gap-2 max-w-4xl mx-auto">
                <button class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white transition-all shrink-0">
                    <span class="text-xl">+</span>
                </button>
                <div class="flex-1 relative">
                    <textarea id="messageInput" placeholder="Message @agent..." rows="1" 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 pr-10 text-sm focus:outline-none focus:border-cyan-500/50 resize-none overflow-hidden"
                        style="min-height: 44px; max-height: 120px;"
                        oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,120)+'px'"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                </div>
                <button onclick="sendMessage()" class="w-10 h-10 gradient-1 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-105 transition-transform shrink-0">
                    <span class="text-lg">&uarr;</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 glass border-t border-white/10 z-50 pb-safe">
        <div class="flex justify-around items-center h-16">
            <a href="./index.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white transition-all">
                <span class="text-xl mb-0.5">üìä</span>
                <span class="text-[10px]">Dashboard</span>
            </a>
            <a href="./agents.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white transition-all">
                <span class="text-xl mb-0.5">ü§ñ</span>
                <span class="text-[10px]">Agents</span>
            </a>
            <a href="./tasks.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white transition-all">
                <span class="text-xl mb-0.5">üìã</span>
                <span class="text-[10px]">Tasks</span>
            </a>
            <a href="./leads.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-white transition-all">
                <span class="text-xl mb-0.5">üë•</span>
                <span class="text-[10px]">Leads</span>
            </a>
            <a href="./chat.html" class="flex flex-col items-center justify-center w-full h-full text-cyan-400">
                <span class="text-xl mb-0.5">üí¨</span>
                <span class="text-[10px]">Chat</span>
            </a>
        </div>
    </nav>

    <script>
let agents = {};
        let agentIdToKey = {};

        async function loadAgents() {
            await DataManager.loadAll();
            const dbAgents = DataManager.getAgents();
            agents = Object.fromEntries(dbAgents.map(a => {
                const key = a.id.replace(/_/g, '');
                agentIdToKey[a.id] = key;
                return [key, { id: a.id, name: a.name, emoji: a.emoji, color: getAgentColor(a.role) }];
            }));

            // Update header avatars
            const headerAvatars = document.querySelector('.flex.-space-x-2');
            if (headerAvatars && dbAgents.length >= 3) {
                headerAvatars.innerHTML = dbAgents.slice(0, 3).map(a =>
                    `<div class="w-10 h-10 ${getAgentColor(a.role)} rounded-full flex items-center justify-center text-lg border-2 border-[#0f0f1a]">${a.emoji}</div>`
                ).join('');
            }

            // Update online count
            const onlineCount = document.querySelector('.text-xs.text-green-400');
            if (onlineCount) {
                onlineCount.innerHTML = `<span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span>${dbAgents.length} agents online`;
            }
        }

        function getAgentColor(role) {
            if (role?.toLowerCase().includes('research')) return 'bg-cyan-500/20';
            if (role?.toLowerCase().includes('content') || role?.toLowerCase().includes('wordsmith')) return 'bg-pink-500/20';
            if (role?.toLowerCase().includes('code') || role?.toLowerCase().includes('architect')) return 'bg-yellow-500/20';
            if (role?.toLowerCase().includes('sales') || role?.toLowerCase().includes('deal')) return 'bg-orange-500/20';
            if (role?.toLowerCase().includes('support') || role?.toLowerCase().includes('success')) return 'bg-purple-500/20';
            if (role?.toLowerCase().includes('visual') || role?.toLowerCase().includes('art')) return 'bg-green-500/20';
            return 'bg-gray-500/20';
        }

        function addMention(name) {
            const input = document.getElementById('messageInput');
            input.value += '@' + name + ' ';
            input.focus();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            const container = document.getElementById('messagesContainer');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            container.insertAdjacentHTML('beforeend', `
                <div class="flex gap-3 justify-end">
                    <div class="flex flex-col items-end max-w-[80%]">
                        <div class="message-user p-3.5 text-sm text-white">${text}</div>
                        <span class="text-[10px] text-gray-500 mt-1 mr-1">${time}</span>
                    </div>
                </div>
            `);

            input.value = '';
            input.style.height = '44px';
            container.scrollTop = container.scrollHeight;

            const mentioned = Object.keys(agents).find(a => text.toLowerCase().includes('@'+a) || text.toLowerCase().includes('@'+agents[a].name.toLowerCase().replace(/\s+/g, '')));
            if (mentioned) {
                showTyping(mentioned);
                setTimeout(() => {
                    hideTyping();
                    sendAgentReply(mentioned);
                }, 1500);
            }
        }

        function showTyping(agent) {
            const a = agents[agent];
            if (!a) return;
            document.getElementById('typingAvatar').textContent = a.emoji;
            document.getElementById('typingAvatar').className = `w-8 h-8 ${a.color} rounded-full flex items-center justify-center text-sm shrink-0 border border-white/10`;
            document.getElementById('typingIndicator').classList.remove('hidden');
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        function sendAgentReply(agent) {
            const a = agents[agent];
            if (!a) return;
            const responses = [
                "I'll get right on that!",
                "Working on it now...",
                "Got it, thanks for the ping!",
                "On my way!"
            ];
            const reply = responses[Math.floor(Math.random() * responses.length)];
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            document.getElementById('messagesContainer').insertAdjacentHTML('beforeend', `
                <div class="flex gap-3">
                    <div class="w-8 h-8 ${a.color} rounded-full flex items-center justify-center text-sm shrink-0 border border-white/10">${a.emoji}</div>
                    <div class="flex-1 max-w-[80%]">
                        <div class="message-agent p-3.5 text-sm text-white/90">
                            <p class="font-semibold text-cyan-400 mb-1">${a.name}</p>
                            <p>${reply}</p>
                        </div>
                        <span class="text-[10px] text-gray-500 mt-1 ml-1">${time}</span>
                    </div>
                </div>
            `);
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        }

        window.addEventListener('load', loadAgents);
    </script>
</body>
</html>
